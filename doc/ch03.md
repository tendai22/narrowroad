---
link:
  - rel: 'stylesheet'
    href: 'css/sample1.css'
lang: ja
---
# 3. Forth言語処理系

この章では、Forth処理系を簡単に説明する。Forthは「言語」なのだが、文法や意味(Syntax and Semantics)という枠組みで説明したくない。入力としてFORTH言語で書かれたプログラムがどのようにして解釈実行されるのか、という実行系を説明のメインに置く。

「文法を満たさないプログラム」をForth処理系は撥ねない。文法エラーだから処理しませんにならないのだ。THEN で終端されていないIF文であってもそのまま実行して訳の分からないことになるだけである。プログラムをざっくり書いて文法チェックをコンパイラに任せている私には到底ついてゆけない厳しさなのだ。こんな言語処理系の「文法」を理解して意味があるのだろうか。

この本のテーマは、Moore師匠の旅路をたどることにある。具体的には「もし19番目のCPUの上で処理系を動かさねばならなくなったMoore師匠に代わって私が処理系を『実装』する」ので、実装対象のプログラムについて読者の皆様にも伝えておきたい。ここでそれを行う。

## Forth実行系の概要

Forth実行系を一言でいえば、インタプリタである。ターミナル/ファイルから入力されるテキスト列を解釈し、実行する。

解釈と実行は単純なループである。

* 次の空白で区切られた文字列を切り出し、
* それが数値であれば、データスタックトップにその数値を置き、
* それが数値でなければ、その文字列に対応する実行コードを探し出して呼び出す。
* 終われば次の文字列の切り出しを始める  
  (次の文字列が無ければ実行を停止する)

これだけである。

* **空白で区切られた文字列** : Forthで文法らしいところがあるとすれば、この「空白で区切られた文字列」である。空白かそれ以外かだけなので、記号も数字もわけへだてなく文字列として扱われる。

* **数値であれば** : 先頭が数字から始まる文字列は数値とみなされ、数値に変換される。通常は整数に変換される。正の数負の数も問題ない。普通のForthでは浮動小数点数は使用できない。

* **データスタックトップ** : Forthでは演算対象の数値(オペランド)、サブルーチンの引数は全てForth処理系が管理するスタックの上にプッシュされる。このスタックをデータスタックという。例えば加算サブルーチンは、スタックトップの数値とその次の数値の和を計算し、スタック上の数値2つを消し、和の数値をスタックトップに置くのである。Forthがスタックマシンといわれるゆえんである。

* **文字列に対応する実行コードを探し出して** : この実行コードが「サブルーチン」になる。数値以外の文字列は**ワード**とみなされ、ワードと対応する実行コードのペアを保持するデータベース上で検索される。このデータベースが**辞書(Dictionary)**である。辞書中にそのワードのエントリが存在すれば、その中にあるサブルーチンを呼び出す。<br>
サブルーチンには2種類ある。一つは、機械語列で構成されるもの、もう一つは、辞書のエントリのアドレスの列を実行するものである。後者がForth処理系のカナメの一つとなる。

単純な例だと、コード
```
  1 2 + .
```
である。これは、
* 整数1をスタックトップに置き
* 整数2をその上に置き、
* それら2つの和を取りスタックトップに置いて  
  (`+`に対応するサブルーチンを辞書から探し出して実行する)
* スタックトップの値(3)を印字する  
  (`.`に対応するサブルーチンを辞書から探し出して実行する)

という一連の処理を実行する。

ワード`+`は「和を計算する」サブルーチンであり、ワード`.`は、「スタックトップの値を印字する」サブルーチンである。

辞書の中に、ワード`+`のエントリとワード`.`のエントリがあり、それぞれ上記のサブルーチンの機械語列を格納している。

## ワードを定義する

Forth言語でワードを定義することができる。定義したワードは辞書に追加され、以後にワードとして実行することができる。

ワードを定義するときは、実行したいワード列を`:`(コロン)と`;`(セミコロン)で囲む。例えば、
```
  : +1 1 + ;
```
である。何のことやらという感じであるが、これは「スタックトップの値を1増やす」ワード`+1`を定義しているのである。

定義されたワード、ここではワード`+1`のエントリの中には、実行コードとして、
* 数値1をスタックトップに置くワードエントリのアドレス
* ワード`+`のアドレス

の2アドレスを持つ。このように、ワードを定義すると**ワードのアドレスの列**を含むエントリが生成され、辞書に追加される。ワード `+1`が実行されると、その中のアドレス列を手繰りながらワードを順次実行してゆく。



  